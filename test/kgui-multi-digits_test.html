<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, user-scalable=yes">

    <title>kgui-multi-digits test</title>

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>

    <link rel="import" href="../kgui-multi-digits.html">
  </head>
  <body>
    <test-fixture id="basic">
      <template>
        <kgui-multi-digits></kgui-multi-digits>
      </template>
    </test-fixture>

    <script>
      /* global
          suite, setup, fixture, test, assert
       */

      suite('kgui-multi-digits', function() {
        var decimalSeparator = (1.1).toLocaleString().replace(/1/g, '');
        var element;

        /**
         * To fire a CLICK event on those ADD, SUBTRACT buttons.
         * @param {Element} el element object to dispatch the EVENT `type` on.
         * @param {String} eType stands for EventType
         */
        function eventFire(el, eType) {
          if (el.fireEvent) {
            el.fireEvent('on' + eType);
          } else {
            var evObj = document.createEvent('Events');
            evObj.initEvent(eType, true, false);
            el.dispatchEvent(evObj);
          }
        }

        // -----------------------------------------------------------------------------------
        // Test preparation
        // -----------------------------------------------------------------------------------

        // Will be executed at the beginning of every test().
        setup(function() {
          element = fixture('basic');
        });

        // -----------------------------------------------------------------------------------
        // Elementary
        // -----------------------------------------------------------------------------------

        test('A01 - Instantiating the default element works', function() {
          assert.equal(element.is, 'kgui-multi-digits');
        });

        test('A02 - Default format `(#,##)#.#`', function() {
          assert.equal(element.format, '(#,##)#.#');

          // Check _core data
          assert.equal(element._core.digitCount, 5);

          if (decimalSeparator === ',') { // Continental European
            assert.equal(element._core.decimalSeparator, ',');
            assert.equal(element._core.thousandSeparator, '.');
            assert.equal(element._core.decimalCount, 1);
            assert.equal(element._core.fractionCount, 4);
            assert.equal(element._core.decimalMarkPosition, 2); // Counting from left to right, start at zero.
          } else {
            assert.equal(element._core.decimalSeparator, '.');
            assert.equal(element._core.thousandSeparator, ',');
            assert.equal(element._core.decimalCount, 4);
            assert.equal(element._core.fractionCount, 1);
            assert.equal(element._core.decimalMarkPosition, 7); // Counting from left to right, start at zero.
          }
        });

        test('A03 - Default value 0', function() {
          assert.equal(element.number, 0);
        });

        // -----------------------------------------------------------------------------------
        // Function validateFormat()
        // -----------------------------------------------------------------------------------

        // Writing and testing https://regex101.com/
        test('B01 - validateNumber()', function() {
          // default situation
          assert.equal(element.number, 0);

          // Some acceptable numbers
          assert.equal(element.validateToNumber(1), 1); // Just one digit
          assert.equal(element.validateToNumber('1'), 1); // Just one digit
          assert.equal(element.validateToNumber(99), 99); // two digits
          assert.equal(element.validateToNumber(123456789), 123456789); // A lot digits
          assert.equal(element.validateToNumber('9,9'), 9.9); // COMMA is not a floating point indicator

          // Some unacceptable numbers
          assert.equal(element.validateToNumber(-1.2), 0); // Negative not supported
        });

        test('B02 - validateFormat(`(#,##)#.#`)', function() {
          // Some acceptable formats
          assert.equal(element.validateFormat('#'), true); // Just one digit

          // Check _core data
          element.setAttribute('format', '#');
          assert.equal(element._core.digitCount, 1);
          assert.equal(element._core.decimalCount, 1);
          assert.equal(element._core.fractionCount, 0);
          assert.equal(element._core.decimalMarkPosition, undefined); // Counting from richt to left, start at zero.

          assert.equal(element.validateFormat('#,#'), true); // Two digits diveded by a ','

          // Check _core data
          element.setAttribute('format', '#,#');
          assert.equal(element._core.digitCount, 2);
          if (decimalSeparator === ',') { // Continental European
            assert.equal(element._core.decimalCount, 1);
            assert.equal(element._core.fractionCount, 1);
            assert.equal(element._core.decimalMarkPosition, 1); // Counting from richt to left, start at zero.
          } else {
            assert.equal(element._core.decimalCount, 0);
            assert.equal(element._core.fractionCount, 0);
            assert.equal(element._core.decimalMarkPosition, undefined); // Counting from richt to left, start at zero.
          }

          assert.equal(element.validateFormat('#.#'), true); // Two digits diveded by a ','

          // Check _core data
          element.setAttribute('format', '#.#');
          assert.equal(element._core.digitCount, 2);
          if (decimalSeparator === ',') { // Continental European
            assert.equal(element._core.decimalCount, 2);
            assert.equal(element._core.fractionCount, 0);
            assert.equal(element._core.decimalMarkPosition, undefined); // Counting from richt to left, start at zero.
          } else {
            assert.equal(element._core.decimalCount, 0);
            assert.equal(element._core.fractionCount, 2);
            assert.equal(element._core.decimalMarkPosition, 1); // Counting from richt to left, start at zero.
          }

          assert.equal(element.validateFormat('##.#'), true); // 00,0
          assert.equal(element.validateFormat('(#)#.#'), true); // (0)0,0
          assert.equal(element.validateFormat('#,###.##'), true); // (0.0.)0.0

          // Check _core data
          element.setAttribute('format', '#,###.##');
          assert.equal(element._core.digitCount, 6);
          if (decimalSeparator === ',') { // Continental European
            assert.equal(element._core.decimalCount, 1);
            assert.equal(element._core.fractionCount, 5);
            assert.equal(element._core.decimalMarkPosition, 1); // Counting from richt to left, start at zero.
          } else {
            assert.equal(element._core.decimalCount, 4);
            assert.equal(element._core.fractionCount, 2);
            assert.equal(element._core.decimalMarkPosition, 5); // Counting from richt to left, start at zero.
          }

          assert.equal(element.validateFormat('(#.#).#.#'), true); // (0.0.)0.0

          // Some unacceptable formats
          assert.throws(function() {
            element.validateFormat('a');
          }, 'Always start with `#` OR `(#` and always end with an `#`.');

          assert.throws(function() {
            element.validateFormat('#(#)');
          }, 'Always start with `#` OR `(#` and always end with an `#`.');

          assert.throws(function() {
            element.validateFormat('(#a)#');
          }, 'Allowed characters `.,#()`.');

          assert.throws(function() {
            element.validateFormat('(#');
          }, 'Missing end `)`.');

          assert.throws(function() {
            element.validateFormat('(#))#');
          }, 'No matching `()`.');

          assert.throws(function() {
            element.validateFormat('#)#');
          }, 'No matching `()`.');

          assert.throws(function() {
            element.validateFormat('(#(#))#');
          }, 'No matching `()`.');

          assert.throws(function() {
            element.validateFormat('(#(#)#');
          }, 'No matching `()`.');
        });

        // Test depends on LOCAL US '9,999,999.99' and not European '9.999.999,99'.
        test('B03 - Maximum number specified by format', function() {
          element.setAttribute('format', '#');
          assert.equal(element._core.maxNumber, 9); // Negative not supported

          element.setAttribute('format', '######');
          assert.equal(element._core.maxNumber, 999999);

          if (decimalSeparator === ',') { // Continental European
            assert.equal(element.getAttribute('local-decimal'), ','); // Negative not supported

            element.setAttribute('format', '#,#');
            assert.equal(element._core.maxNumber, 9.9);

            element.setAttribute('format', '#,###');
            assert.equal(element._core.maxNumber, 9.999);

            element.setAttribute('format', '(###)#,#');
            assert.equal(element._core.maxNumber, 9999.9);

            element.setAttribute('format', '(#.##)#.###,#');
            assert.equal(element._core.maxNumber, 9999999.9);
          } else {
            assert.equal(element.getAttribute('local-decimal'), '.'); // Negative not supported

            element.setAttribute('format', '#.#');
            assert.equal(element._core.maxNumber, 9.9);

            element.setAttribute('format', '#.###');
            assert.equal(element._core.maxNumber, 9.999);

            element.setAttribute('format', '(###)#.#');
            assert.equal(element._core.maxNumber, 9999.9);

            element.setAttribute('format', '(#,##)#,###.#');
            assert.equal(element._core.maxNumber, 9999999.9);
          }
        });

        // -----------------------------------------------------------------------------------
        // Functionality
        // -----------------------------------------------------------------------------------

        test('C01 - Default layout behavior MAX (99999) value', function() {
          element.setAttribute('format', '#####');
          element.setAttribute('number', 99999);

          assert.equal(element.$$('#digit0').$$('#btnUp').disabled, true);
          assert.equal(element.$$('#digit1').$$('#btnUp').disabled, true);
          assert.equal(element.$$('#digit2').$$('#btnUp').disabled, true);
          assert.equal(element.$$('#digit3').$$('#btnUp').disabled, true);
          assert.equal(element.$$('#digit4').$$('#btnUp').disabled, true);

          assert.equal(element.$$('#digit0').$$('#btnDown').disabled, false);
          assert.equal(element.$$('#digit1').$$('#btnDown').disabled, false);
          assert.equal(element.$$('#digit2').$$('#btnDown').disabled, false);
          assert.equal(element.$$('#digit3').$$('#btnDown').disabled, false);
          assert.equal(element.$$('#digit4').$$('#btnDown').disabled, false);
        });

        test('C02 - Default layout behavior MIN (0) value', function() {
          element.setAttribute('format', '#####');
          element.setAttribute('number', 12345);
          element.setAttribute('number', 0);

          assert.equal(element.$$('#digit0').$$('#btnUp').disabled, false);
          assert.equal(element.$$('#digit1').$$('#btnUp').disabled, false);
          assert.equal(element.$$('#digit2').$$('#btnUp').disabled, false);
          assert.equal(element.$$('#digit3').$$('#btnUp').disabled, false);
          assert.equal(element.$$('#digit4').$$('#btnUp').disabled, false);

          assert.equal(element.$$('#digit0').$$('#btnDown').disabled, true);
          assert.equal(element.$$('#digit1').$$('#btnDown').disabled, true);
          assert.equal(element.$$('#digit2').$$('#btnDown').disabled, true);
          assert.equal(element.$$('#digit3').$$('#btnDown').disabled, true);
          assert.equal(element.$$('#digit4').$$('#btnDown').disabled, true);
        });

        test('C03 - Default format layout INTEGER - thousants divider', function() {
          var nodes;

          if (decimalSeparator === ',') { // Continental European
            element.setAttribute('format', '##.###.###');
          } else {
            element.setAttribute('format', '##,###,###');
          }
          element.setAttribute('number', 12345678);

          nodes = element.$.digits.childNodes;
          assert.equal(nodes.length, 10); // Including numbers and formatters (,.)

          assert.equal(nodes[0].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[0].digit, '1');

          assert.equal(nodes[1].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[1].digit, '2');

          assert.equal(nodes[2].nodeName, 'DIV');
          assert.equal(nodes[2].textContent, '.');

          assert.equal(nodes[3].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[3].digit, '3');

          assert.equal(nodes[4].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[4].digit, '4');

          assert.equal(nodes[5].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[5].digit, '5');

          assert.equal(nodes[6].nodeName, 'DIV');
          assert.equal(nodes[6].textContent, '.');

          assert.equal(nodes[7].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[7].digit, '6');

          assert.equal(nodes[8].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[8].digit, '7');

          assert.equal(nodes[9].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[9].digit, '8');
        });

        test('C04 - Optional format as default', function() {
          // TODO: Test fractions assert.equal(element.format, '(#,##)#.#');
          if (decimalSeparator === ',') { // Continental European
            element.setAttribute('format', '(#.##)#'); // NO DECIMAL FRACTIONS !!!!!
          } else {
            element.setAttribute('format', '(#,##)#'); // NO DECIMAL FRACTIONS !!!!!
          }
          assert.equal(element._core.digitCount, 4);
          assert.equal(element._core.decimalCount, 4);
          assert.equal(element._core.fractionCount, 0); // NO DECIMAL FRACTIONS !!!!!
          assert.equal(element._core.decimalMarkPosition, undefined); // No fractions

          // Visible on screen 0.0
          assert.equal(element.number, 0); // Visible as '0'
          assert.equal(element.$$('#digit0').digit, '0'); // 1
          assert.equal(element.$$('#digit0').classList.contains('symbol__invisible'), false);
          assert.equal(element.$$('#digit1').digit, '0'); // 10
          assert.equal(element.$$('#digit1').classList.contains('symbol__invisible'), true);
          assert.equal(element.$$('#digit2').digit, '0'); // 100
          assert.equal(element.$$('#digit2').classList.contains('symbol__invisible'), true);
          assert.equal(element.$$('#digit3').digit, '0'); // 1000
          assert.equal(element.$$('#digit3').classList.contains('symbol__invisible'), true);
        });

        test('C05 - Optional format as default', function() {
          // (#,#1)2
          if (decimalSeparator === ',') { // Continental European
            element.setAttribute('format', '(#.##)#');
          } else {
            element.setAttribute('format', '(#,##)#');
          }

          element.setAttribute('number', 12);
          assert.equal(element.number, 12);
          assert.equal(element.$$('#digit0').digit, '2'); // 1
          assert.equal(element.$$('#digit0').classList.contains('symbol__invisible'), false);

          assert.equal(element.$$('#digit1').digit, '1'); // 10
          assert.equal(element.$$('#digit1').classList.contains('symbol__invisible'), false);

          assert.equal(element.$$('#digit2').digit, '0'); // 100
          assert.equal(element.$$('#digit2').classList.contains('symbol__invisible'), true);
          assert.equal(element.$$('#token2').classList.contains('symbol__invisible'), true);

          assert.equal(element.$$('#digit3').digit, '0'); // 1000
          assert.equal(element.$$('#digit3').classList.contains('symbol__invisible'), true);

          element.setAttribute('number', 123);
          assert.equal(element.number, 123);
          assert.equal(element.$$('#digit0').digit, '3'); // 1
          assert.equal(element.$$('#digit0').classList.contains('symbol__invisible'), false);

          assert.equal(element.$$('#digit1').digit, '2'); // 10
          assert.equal(element.$$('#digit1').classList.contains('symbol__invisible'), false);

          assert.equal(element.$$('#digit2').digit, '1'); // 100
          assert.equal(element.$$('#digit2').classList.contains('symbol__invisible'), false);
          assert.equal(element.$$('#token2').classList.contains('symbol__invisible'), true);

          assert.equal(element.$$('#digit3').digit, '0'); // 1000
          assert.equal(element.$$('#digit3').classList.contains('symbol__invisible'), true);
        });

/*
        test('C03 - Default format layout FLOAT', function(done) {
          var nodes;

          element.setAttribute('format', '##.###.###,##');
          element.setAttribute('number', 12345678.90);

          setTimeout(function() {

          nodes = element.$.digits.childNodes;
          assert.equal(nodes.length, 13); // Including numbers and formatters (,.)
console.log(nodes[0], nodes[0].digit);
console.log(nodes[1], nodes[1].digit);
console.log(nodes[2]);

          assert.equal(nodes[0].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[0].digit, '1');

          assert.equal(nodes[1].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[1].digit, '2');

          assert.equal(nodes[2].nodeName, 'DIV');
          assert.equal(nodes[2].textContent, '.');

          assert.equal(nodes[3].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[3].digit, '3');

          assert.equal(nodes[4].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[4].digit, '4');

          assert.equal(nodes[5].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[5].digit, '5');

          assert.equal(nodes[6].nodeName, 'DIV');
          assert.equal(nodes[6].textContent, '.');

          assert.equal(nodes[7].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[7].digit, '6');

          assert.equal(nodes[8].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[8].digit, '7');

          assert.equal(nodes[9].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[9].digit, '8');

          assert.equal(nodes[10].nodeName, 'DIV');
          assert.equal(nodes[10].textContent, ',');

          assert.equal(nodes[11].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[11].digit, '9');

          assert.equal(nodes[12].nodeName, 'KGUI-SINGLE-DIGIT');
          assert.equal(nodes[12].digit, '0');
            done();
          }, 10);
        });
*/
      });

    </script>
  </body>
</html>
